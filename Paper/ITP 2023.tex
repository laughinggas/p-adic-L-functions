\documentclass[a4paper,UKenglish,cleveref, autoref, thm-restate]{lipics-v2021}
%This is a template for producing LIPIcs articles. 
%See lipics-v2021-authors-guidelines.pdf for further information.
%for A4 paper format use option "a4paper", for US-letter use option "letterpaper"
%for british hyphenation rules use option "UKenglish", for american hyphenation rules use option "USenglish"
%for section-numbered lemmas etc., use "numberwithinsect"
%for enabling cleveref support, use "cleveref"
%for enabling autoref support, use "autoref"
%for anonymousing the authors (e.g. for double-blind review), add "anonymous"
%for enabling thm-restate support, use "thm-restate"
%for enabling a two-column layout for the author/affilation part (only applicable for > 6 authors), use "authorcolumns"
%for producing a PDF according the PDF/A standard, add "pdfa"

%\pdfoutput=1 %uncomment to ensure pdflatex processing (mandatatory e.g. to submit to arXiv)
%\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository

%\graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\bibliographystyle{plainurl}% the mandatory bibstyle

\title{Formalisation of $p$-adic $L$-functions in Lean 3} %TODO Please add

\titlerunning{$p$-adic $L$-functions} %TODO optional, please use if title is longer than one line

\author{Ashvni Narayanan}{London School of Geometry and Number Theory, Imperial College London}{a.narayanan20@imperial.ac.uk}{https://orcid.org/0000-0003-2777-4228}{EPSRC Grant EP/S021590/1 (UK)}%TODO mandatory, please use full name; only 1 author per \author macro; first two parameters are mandatory, other parameters can be empty. Please provide at least the name of the affiliation and the country. The full address is optional. Use additional curly braces to indicate the correct name splitting when the last name consists of multiple name parts.

%\author{Joan R. Public\footnote{Optional footnote, e.g. to mark corresponding author}}{Department of Informatics, Dummy College, [optional: Address], Country}{joanrpublic@dummycollege.org}{[orcid]}{[funding]}

\authorrunning{A. Narayanan} %TODO mandatory. First: Use abbreviated first/middle names. Second (only in severe cases): Use first author plus 'et al.'

\Copyright{Ashvni Narayanan} %TODO mandatory, please use full first names. LIPIcs license is "CC-BY";  http://creativecommons.org/licenses/by/3.0/

\ccsdesc[500]{Mathematics of computing~Mathematical software} %TODO mandatory: Please choose ACM 2012 classifications from https://dl.acm.org/ccs/ccs_flat.cfm 
\ccsdesc[300]{Theory of computation~Formal languages and automata theory}

\keywords{formal math, algebraic number theory, Lean, mathlib} %TODO mandatory; please add comma-separated list of keywords

%\category{} %optional, e.g. invited paper

%\relatedversion{} %optional, e.g. full version hosted on arXiv, HAL, or other respository/website
%\relatedversiondetails[linktext={opt. text shown instead of the URL}, cite=DBLP:books/mk/GrayR93]{Classification (e.g. Full Version, Extended Version, Previous Version}{URL to related version} %linktext and cite are optional

\supplement{Copies of the source files relevant to this paper are available in a separate repository.}%optional, e.g. related research data, source code, ... hosted on a repository like zenodo, figshare, GitHub, ...
\supplementdetails[swhid={}]{Software}{https://github.com/laughinggas/p-adic-L-functions} %linktext, cite, and subcategory are optional

%\funding{(Optional) general funding statement \dots}%optional, to capture a funding statement, which applies to all authors. Please enter author specific funding statements as fifth argument of the \author macro.

\acknowledgements{The author is supported by EPSRC. The author would like to thank her PhD supervisor Prof Kevin Buzzard for several helpful insights. 
She would also like to thank Dr Filippo A. E. Nuccio for helpful conversations that helped give shape to the project. She is very grateful 
to the entire Lean community for their timely help and consistent support.}%optional

%\nolinenumbers %uncomment to disable line numbering



%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access}
\EventNoEds{2}
\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
\EventShortTitle{CVIT 2016}
\EventAcronym{CVIT}
\EventYear{2016}
\EventDate{December 24--27, 2016}
\EventLocation{Little Whinging, United Kingdom}
\EventLogo{}
\SeriesVolume{42}
\ArticleNo{23}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{hyperref}
\usepackage{makecell}
\usepackage{xcolor}
\usepackage{xspace}
\usepackage{listings}
%\usepackage{minted}
\def\lstlanguagefiles{lstlean.tex}
\lstset{language=lean}
%\bibliographystyle{plainurl}

\addtolength{\oddsidemargin}{-.875in}
\addtolength{\evensidemargin}{-.875in}
\addtolength{\textwidth}{1.75in}

\definecolor{keywordcolor}{rgb}{0.7, 0.1, 0.1}   % red
\definecolor{commentcolor}{rgb}{0.4, 0.4, 0.4}   % grey
\definecolor{symbolcolor}{rgb}{0.4, 0.4, 0.4}    % grey
\definecolor{sortcolor}{rgb}{0.1, 0.5, 0.1}      % green

\newcommand{\C}{\mathbb{C}}
\newcommand{\lean}[1]{\texttt{#1}\xspace} % for writing Lean expressions
\newcommand*{\OK}[1][K]{\mathcal{O}_{#1}}
\newcommand*{\Cl}{\mathcal{C}\kern-.075em l}
% \DeclareMathOperator{\Cl}{Cl}
\newcommand*{\Fq}[1][q]{\mathbb{F}_{#1}}
\DeclareMathOperator{\Tr}{Tr}
\newcommand{\mathlib}{\textsf{mathlib}\xspace}
\newcommand{\N}{\mathbb{N}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\pow}{\textasciicircum\xspace}
\newcommand{\Q}{\mathbb{Q}}
% \newcommand{\Qbar}{\mathbb{\bar{Q}}}
\newcommand{\Z}{\mathbb{Z}}
\DeclareMathOperator{\Frac}{Frac}

\DeclareUnicodeCharacter{21D1}{\ensuremath{\Uparrow}}
\DeclareUnicodeCharacter{2194}{\ensuremath{\longleftrightarrow}}
\DeclareUnicodeCharacter{1D4DD}{\ensuremath{\mathcal{N}}}
\DeclareUnicodeCharacter{22C3}{\ensuremath{\bigcup}}
\DeclareUnicodeCharacter{03BB}{\ensuremath{\lambda}}
\DeclareUnicodeCharacter{03B1}{\ensuremath{\alpha}}
\DeclareUnicodeCharacter{03C3}{\ensuremath{\sigma}}
\DeclareUnicodeCharacter{03C7}{\ensuremath{\chi}}
\DeclareUnicodeCharacter{2081}{\ensuremath{_1}}
\DeclareUnicodeCharacter{2082}{\ensuremath{_2}}
\DeclareUnicodeCharacter{2090}{\ensuremath{_a}}
\DeclareUnicodeCharacter{2097}{\ensuremath{_l}}
\DeclareUnicodeCharacter{211A}{\ensuremath{\Q}}
\DeclareUnicodeCharacter{2124}{\ensuremath{\Z}}
\DeclareUnicodeCharacter{2115}{\ensuremath{\N}}
\DeclareUnicodeCharacter{2211}{\ensuremath{\sum}}
\DeclareUnicodeCharacter{2264}{\ensuremath{\l}}
\DeclareUnicodeCharacter{2286}{\ensuremath{\subseteq}}
\DeclareUnicodeCharacter{22A4}{\ensuremath{\top}}
\DeclareUnicodeCharacter{22A5}{\ensuremath{\bot}}
\DeclareUnicodeCharacter{2243}{\ensuremath{\simeq}}
\DeclareUnicodeCharacter{2080}{\ensuremath{_0}}
\DeclareUnicodeCharacter{03C8}{\ensuremath{\psi}}
\DeclareUnicodeCharacter{2225}{\ensuremath{\lVert}}
\DeclareUnicodeCharacter{2A06}{\ensuremath{\bigsqcup}}
\DeclareUnicodeCharacter{02E3}{\ensuremath{^{\times}}}
\DeclareUnicodeCharacter{03B5}{\ensuremath{\varepsilon}}
\DeclareUnicodeCharacter{2203}{\ensuremath{\exists}}
\DeclareUnicodeCharacter{2200}{\ensuremath{\forall}}
\DeclareUnicodeCharacter{2265}{\ensuremath{\ge}}
\DeclareUnicodeCharacter{1DA0}{\ensuremath{^{\texttt{f}}}}
%\newunicodechar{^}{\ensuremath{\textasciicircum}}

\renewcommand\UrlFont{\color{blue}\rmfamily}

\begin{document}

\maketitle

%TODO mandatory: add short abstract of the document
\begin{abstract}
This paper decribes formalisation of $p$-adic $L$-functions in an interactive theorem prover Lean 3. $p$-adic 
$L$-functions are fundamental number theoretic objects. These special functions emerge from the special 
values they take at negative integers in terms of generalized Bernoulli polynomials. We formalise their 
definition in terms of a $p$-adic integral with respect to the Bernoulli measure, and prove that they 
take the required values at negative integers.
\end{abstract}

\section{Introduction}
We are working on formalising mathematics in an interactive theorem prover called Lean. 
Formal verification involves the use of logical and computational methods to establish 
claims that are expressed in precise mathematical terms \cite{TPIL}. Lean is a powerful tool 
that facilitates formalisation of a system of mathematics supported by a basic set of axioms. There is a large mathematical library of theorems verified by Lean called \lean{mathlib}, maintained by a community of computer scientists and mathematicians. One can then 
formally verify proofs of new theorems dependent on preexisting theorems in \lean{mathlib}. 
\lean{mathlib} currently contains 100579 theorems(as of early October 2022). It would be impossible to construct 
such a vast library without a highly collaborative spirit and a communal decentralized effort, one of 
Lean's best features. 

$p$-adic $L$-functions are a well studied number theoretic object. They were initially constructed 
by Kubota and Leopoldt in \cite{KL}. Their motivation was to construct a meromorphic function that helps study 
the Kummer congruence for Bernoulli numbers, and gives information regarding $p$-adic class numbers. 
%%They appear in several places, such as the Birch and Swinnerton-Dyer Conjecture. 
As a result, these functions take twisted values of the Dirichlet $L$-function at negative integers, and 
are also related to the generalized Bernoulli numbers and the $p$-adic zeta function. There are several different ways of 
constructing $p$-adic $L$-functions, we refer to the constructions
given in Chapter 12 of \cite{cyc}. This has never been done before in any 
theorem prover. As a result, one needs to build a lot of background (in the maximum possible generality) 
before embarking on the main goal.

We first give a mathematical overview in this section. The following tools are needed to construct $p$-adic $L$-functions : Dirichlet characters, Bernoulli numbers and polynomials, locally compact Hausdorff totally
disconnected spaces, and the $p$-adic integers and its topological properties.
We introduce these in Section \ref{section2}, define the $p$-adic $L$-function in Section \ref{section3}, and evaluate it at negative integers in Section \ref{section4}, finishing with a summary in Section \ref{section5}. 
%% explain more about how mathlib works
\subsection{Mathematical overview}
We give a brief overview of the mathematics formalised in this project. 
$L$-functions are a fundamental object, appearing almost everywhere in modern 
number theory. The Dirichlet $L$-function associated to a Dirichlet character $\chi$ is given by  
$$ L(s, \chi) = \sum_{n = 1}^{\infty} \frac{\chi (n)}{n^s} = \prod_{p \text{ prime}} \frac{1}{1 - \chi (p) p^{-s}}$$
where $s$ is a complex variable with $Re(s) > 1$. This can be analytically extended 
to the entire complex plane, with a simple pole at $s = 1$ when $\chi = 1$. Note also 
that $L(s, 1)$ is the same as the Reimann zeta function. Moreover, it is known that 
$L(1 - n, \chi) = - \frac{B_{n, \chi}}{n}$, where $B_{n, \chi}$ are the generalized 
Bernoulli numbers. 

In this paper, we construct, for an integer prime $p$, a $p$-adic analogue of $L(s, \chi)$, 
called the Kubota-Leopoldt $p$-adic $L$-function, denoted $L_p(s, \chi)$. This is generally done by continuously extending the function 
$L_p(1 - n, \chi) := (1 - \chi (p) p^{n - 1}) L(1 - n, \chi)$ to the complete $p$-adic space 
$\mathbb{C}_p$. In fact, $L_p(s, 1)$ is analytic except for a pole at $s = 1$ with residue 
$1 - \frac{1}{p}$ (Theorem 5.11, \cite{cyc}). 

Formalisation of the $p$-adic $L$-functions via analytic continuation was hard, since $\mathbb{C}_p$ did not exist 
in \lean{mathlib} at the time. Following \cite{cyc}, 
we define it in terms of a ``$p$-adic integral'' with respect to the Bernoulli measure. We explain these terms below. 

A profinite space is a compact, Hausdorff and totally disconnected space. The $p$-adic integers 
$\mathbb{Z}_p$, which are the completion of the integers $\mathbb{Z}$ with respect to the 
valuation $\nu_p(p^{\alpha} \prod_{p_i \ne p} p_i^{\alpha_i}) = \alpha$ are a profinite space. 
One may also think of them as the inverse limit of the discrete topological spaces 
$\mathbb{Z} / p^{n} \mathbb{Z}$, that is, $\mathbb{Z}_p = \projlim_{n} \mathbb{Z} / p^{n} \mathbb{Z}$. 
A corollary of this is that $\mathbb{Z}_p$ has a topological basis of clopen sets (both open and closed), 
$(\{ x \in \mathbb{Z}_p | x \equiv a (\text{mod } p^n) \})_{n, a}$, for $n \in \mathbb{N}$ and $a \in \mathbb{Z} / p^{n} \mathbb{Z}$. 

Locally constant functions are those for which the preimage of any set is open. Given a profinite space $X$ and a normed ring $R$, 
one can show that the locally constant functions from $X$ to $R$ (denoted $LC(X, R)$) are dense in the space of continuous 
functions from $X$ to $R$ (denoted $C(X, R)$). 

Given an abelian group $A$, a distribution is defined to be an $A$-linear map from $LC(X, A)$ 
to $A$. A $p$-adic measure $\phi$ is defined to be a bounded distribution, that is, $\forall f \in LC(X, R)$, 
$\exists K > 0$ such that $|| \phi (f) || \le K ||f|| $, where $||f|| = \sup_{x \in X} || f(x)||$. 
An example of a $p$-adic measure is a Bernoulli measure. Given a natural number $d$ coprime to $p$ and a clopen set $U_{n, a}$ of 
$\mathbb{Z}/ d \mathbb{Z} \times \mathbb{Z}_p$, the characteristic function $\chi_{n, a}$ 
(defined to be 1 on $U_{n, a}$ and 0 otherwise) is a locally constant function. 
Given a natural number $c$ that is coprime to $d$ and $p$, we then define the Bernoulli measure $E_c$ by :
$$ E_c(U_{n, a}) := \bigg \{ \frac{a}{d p^{n + 1}} \bigg \} - c \bigg \{ \frac{c^{-1} a}{d p^{n + 1}} \bigg \} + \frac{c - 1}{2} $$

Given a $p$-adic measure $\mu$, we define the $p$-adic integral with respect 
to $\mu$ to be $\int f d\mu := \mu (f)$ for any locally constant function $f$, and 
extending this definition to $C(X, R)$. In fact, this is an $R$-linear map. 

Finally, the $p$-adic $L$-function is defined to be a $p$-adic integral with respect to the Bernoulli 
measure. The characterizing property of the $p$-adic $L$-function is its evaluation at negative integers : 
$$ L_p (1 - n, \chi) = -(1 - \chi \omega^{-n}(p)p^{n - 1}) \frac{B_{n, \chi \omega^{-n}}}{n} $$
for $n \ge 1$. If defined as an analytic continuation, this would follow directly. However, when 
defined as a $p$-adic integral, additional work is needed to prove this. The equivalence of these two definitions 
is proved in Theorem 12.2 of \cite{cyc}. The same theorem 
also proves the independence of the definition from the additional variable $c$.

Our contributions to this theory include a formalised definition of the $p$-adic $L$-function in generality, 
taking values in a normed complete non-Archimedean $\mathbb{Q}_p$-algebra, instead of just $\mathbb{C}_p$. Further, it takes as 
input continuous monoid homomorphisms, also known as elements of the weight space. We have also developed an extensive theory for 
Dirichlet characters, Bernoulli numbers and polynomials, generalized Bernoulli numbers, properties of $p$-adic integers and modular arithmetic.
\subsection{Lean and \lean{mathlib}}
Lean 3 is a functional programming language and interactive theorem prover based on
dependent type theory. This project is based on Lean’s 
mathematical library \lean{mathlib 3}, which is characterized by
its decentralized nature with over 300 contributors. Thus, it is impossible to cite every author who contributed a piece of code that we used.

We assume the reader is familiar with structures such as \lean{def}, \lean{abbreviation}, \lean{lemma}, \lean{theorem}, which are used constantly. 
An important property of Lean is its typeclass inference system - 
Lean ``remembers'' properties given to a \lean{structure} or \lean{class} embedded in an \lean{instance} structure. This is explained in detail in \cite{mathlib}. 
We shall also use several tactics in proofs, such as \lean{rw}, \lean{apply}, \lean{conv} and \lean{refine}
\footnote{\url{https://leanprover-community.github.io/mathlib_docs/tactics.html} has a full list of tactics in Lean}.
\section{Preliminaries}
\label{section2}
\subsection{Filters and convergence}
None of the mathematical proofs require filters on paper, however, we find that working with them makes 
formalising these proofs significantly less cumbersome. We shall not delve into the details of what a 
filter is, but instead explain how we use them to formalise convergence and limits. 
Often, we have expressions of the form $\lim_{n \to \infty} f_n(x) = a$ for a sequence of functions $(f_n)_n$. 
This is represented in Lean as :
\begin{lstlisting}
filter.tendsto (λ n : ℕ, f_n) filter.at_top (nhds a)
\end{lstlisting}
Here, \lean{filter.at\_top} (for the naturals) is a filter on $\mathbb{N}$ generated by the collection of sets $\{ b | a \leq b \}$ 
for all $a \in \mathbb{N}$. There is a large library of lemmas regarding \lean{tendsto} in \lean{mathlib}. 
Some important properties that we use frequently include :
\begin{lstlisting}
/-- If lim_n f(n) = a and lim_n g(n) = b, then lim_n f(n) + g(n) = a + b -/
lemma tendsto.add {α : Type} {M : Type u_1} [topological_space M] [has_add M] 
  [has_continuous_add M] {f g : α → M} {x : filter α} {a b : M} 
  (hf : tendsto f x (nhds a)) (hg : tendsto g x (nhds b)) : 
  tendsto (λ (x : α), f x + g x) x (nhds (a + b))
/-- If f = g, then lim f = lim g. -/
lemma filter.tendsto_congr {α : Type} {β : Type u_1} {f₁ f₂ : α → β} {l₁ : filter α} 
  {l₂ : filter β} (h : ∀ (x : α), f₁ x = f₂ x) : tendsto f₁ l₁ l₂ ↔ tendsto f₂ l₁ l₂
/-- If lim (c • f) = 0 for some nonzero constant c, then lim f = 0. -/
lemma tendsto_zero_of_tendsto_const_smul_zero [algebra ℚ_[p] R] {f : ℕ → R} {l : filter ℕ} 
  {c : ℚ_[p]} (hc : c ≠ 0) (hf : tendsto (λ y, c • f y) l (nhds 0)) : tendsto f l (nhds 0) 
/-- If f₁ and f₂ are equal almost everywhere, then f₁ converges if and only if f₂ converges. -/
lemma filter.tendsto_congr' {α : Type} {β : Type u_1} {f₁ f₂ : α → β} {l₁ : filter α} 
  {l₂ : filter β} (h : f₁ =ᶠ[l₁] f₂) : tendsto f₁ l₁ l₂ ↔ tendsto f₂ l₁ l₂
\end{lstlisting}
We aim to use these lemmas as much as possible in order to avoid messy calculations with inequalities on norms. 
The last lemma is particularly useful. it shows that sequences that are the same after finitely many 
elements have the same limit. Given \lean{f₁ f₂ :ℕ → R}, \lean{f₁ =ᶠ[at\_top] f₂ ↔ ∃ (a : ℕ), ∀ (b : ℕ), b ≥ a, f₁ b = f₂ b}. 
\subsection{Modular arithmetic and $\mathbb{Z}_p$}
Some fundamental objects with which we shall work throughout are the finite spaces $\mathbb{Z}/n \mathbb{Z}$. Given $n \in \mathbb{N}$, 
$\mathbb{Z}/n \mathbb{Z}$ is the same as \lean{fin n}, the set of natural numbers upto $n$. This has a natural group structure, and is given the discrete topology, 
making it a topological group. Some of the maps used constantly include \lean{val:zmod n → ℕ}, which takes any element to its smallest nonnegative reprentative less than \lean{n}; 
and \lean{cast\_hom:zmod n → R}, a coercion to a ring, obtained by composing the canonical coercion with \lean{val}. If \lean{R} has characteristic 
dividing \lean{n}, the map is a ring homomorphism. Given coprime natural numbers $m$ and $n$, an important equivalence is : 
\lean{chinese\_remainder:zmod (m * n) ≃+* zmod m × zmod n}. About 30 additional lemmas were required, which have been put in a separate file, 
\href[]{https://github.com/laughinggas/p-adic-L-functions/blob/main/src/zmod_properties.lean}{\lean{zmod\_properties.lean}}. 

%%The \textit{$p$-adic valuation} is a function $\nu_p : \mathbb{Z} \xrightarrow[]{} \mathbb{R}$, such that
%%$\nu_p (p^k) = k$, and for $gcd(a,p) = 1$, $\nu_p (a) = 0$. By convention,$\nu_p (0) = \infty$, however, in Lean, \lean{valuation 0 = 0 }.
We assume $p$ is a prime and $d$ is a positive natural with 
$gcd (d, p) = 1$. The ring of $p$-adic integers, denoted \lean{$\mathbb{Z}$\_[p]}, is the completion of $\mathbb{Z}$ by the $p$-adic
valuation. It has the following properties :
\begin{itemize}
  \item As a profinite limit, $\mathbb{Z}_p = \varprojlim \mathbb{Z} / p^n \mathbb{Z}$. As a result,
  one can find (compatible) surjective ring homomorphisms \lean{to\_zmod\_pow : ℤ\_[p] →+* zmod (p\textasciicircum n)} for all \lean{n}.
  \item $\mathbb{Z}_p$ has the profinite topology, induced by the discrete topology
  on $\mathbb{Z} / p^n \mathbb{Z}$. Hence, $\mathbb{Z}_p$ is a compact, Hausdorff totally disconnected space
  with a clopen basis of the form $( \{ a + p^n \mathbb{Z}_p \} )_{n, a}$ for $a \in \mathbb{Z} / p^n \mathbb{Z}$.
  \item For $p > 2$, $\mathbb{Z}_p^{\times} ≃ (\mathbb{Z}/p \mathbb{Z})^{\times} \times (1 + p \mathbb{Z}_p)$\footnote{$\mathbb{Z}_2^{\times} \cong \{ \pm 1 \} \times (1 + 4 \mathbb{Z}_2)$}.
  Also, $(\mathbb{Z}/d\mathbb{Z})^{\times} \times \mathbb{Z}_p^{\times} ≃
  (\mathbb{Z}/dp \mathbb{Z})^{\times} \times (1 + p \mathbb{Z}_p)$
\end{itemize}

These properties characterize the $p$-adic integers, and are integral to this work. While some preexisted in 
\lean{mathlib}, about 40 additional lemmas have been proved in \href[]{https://github.com/laughinggas/p-adic-L-functions/blob/main/src/padic_int/properties.lean}{\lean{padic\_int.properties.lean}}. 
Moreover, lots of facts regarding the clopen basis given above have been utilized and proved in \href[]{https://github.com/laughinggas/p-adic-L-functions/blob/main/src/padic_int/clopen_properties.lean}{\lean{padic\_int.clopen\_properties.lean}}.
\subsection{Dirichlet characters and the Teichmüller character}
An important task was to formalise Dirichlet characters, an integral part of the definition of the $p$-adic $L$-function. 
Dirichlet characters are often not found to be defined in this technical manner. Another addition is the definition of 
Dirichlet characters of level and conducor 0. The words character and Dirichlet character are used interchangeably. 

The Dirichlet characters are usually defined as group homomorphisms from $\mathbb{Z}/n \mathbb{Z}^{\times}$ to $\mathbb{C}^{\times}$ for some natural number $n$. 
We can then assign levels to Dirichlet characters and relate Dirichlet characters of different levels, constructing a "compatible" system of 
characters for certain values of $n$. We generalize the definition from group homomorphisms to $\mathbb{C}$ to monoid homomorphisms on any 
\lean{monoid} :
\begin{lstlisting}
abbreviation dirichlet_character (R : Type*) [monoid R] (n : ℕ) := units (zmod n) →* units R
abbreviation lev {R : Type*} [monoid R] {n : ℕ} (χ : dirichlet_character R n) : ℕ := n
\end{lstlisting}
Note that the linter returns an extra unused argument warning for the latter definition. 

Given a Dirichlet character $\chi$, \lean{asso\_dirichlet\_character χ} returns a monoid homomorphism from $\mathbb{Z}/n \mathbb{Z}$ 
to $R$, which is $\chi$ on the units and 0 otherwise. Most of our work is on $\mathbb{Z}/n \mathbb{Z}$ instead of its units, hence this 
is a vital definition. 
\begin{lstlisting}
noncomputable abbreviation asso_dirichlet_character {R : Type*} [monoid_with_zero R] {n : ℕ} 
(χ : dirichlet_character R n) : zmod n →* R :=
{ to_fun := function.extend (units.coe_hom (zmod n)) ((units.coe_hom R) ∘ χ) 0,
  map_one' := _,
  map_mul' := _, }
\end{lstlisting}
%The following useful theorem relates the two definitions :
%\begin{lstlisting}
%  lemma asso_dirichlet_character_eq_char {R : Type*} [monoid_with_zero R] {n : ℕ}
%  (χ : dirichlet_character R n) (a : units (zmod n)) : 
%  asso_dirichlet_character χ a = χ a 
%\end{lstlisting}
%\subsubsection{Changing levels, primitivity, multiplication and additional properties}
One would like to shift between compatible Dirichlet characters of different levels. For this, we have the following tools : 
\begin{lstlisting}
/-- Extends the Dirichlet character χ of level n to level m, where n | m. -/
def change_level {m : ℕ} (hm : n | m) : dirichlet_character R m := 
χ.comp (units.map (zmod.cast_hom hm (zmod n)))
/-- χ₀ of level d factors through χ of level n if d | n and χ₀ = χ ∘ (zmod n → zmod d). -/
structure factors_through (d : ℕ) : Prop :=
(dvd : d | n)
(ind_char : ∃ χ₀ : dirichlet_character R d, χ = χ₀.change_level dvd)
\end{lstlisting}
With the assistance of a few lemmas, it is easy to translate between \lean{change\_level} and \lean{factors\_through}. The notions of primitivity 
and conductor of a Dirichlet character follow easily : 
\begin{lstlisting}
/-- The set of natural numbers for which a Dirichlet character is periodic. -/
def conductor_set : set ℕ := {x : ℕ | χ.factors_through x}
/-- The minimum natural number n for which a Dirichlet character is periodic. -/
noncomputable def conductor : ℕ := Inf (conductor_set χ)
/-- A character is primitive if its level is equal to its conductor. -/
def is_primitive : Prop := χ.conductor = n
/-- The primitive character associated to a Dirichlet character. -/
noncomputable def asso_primitive_character : dirichlet_character R χ.conductor :=
classical.some (χ.factors_through_conductor).ind_char
\end{lstlisting}
Here, \lean{classical.some} makes an arbitrary choice of an element from a nonempty space, and \lean{classical.some\_spec} lists down the properties of this random element
coming from the space. 
Our definition of Dirichlet characters holds also for $n = 0$, ie, on $\mathbb{Z}$. 
This is easily separated from the rest by the lemma : 
\begin{lstlisting}
lemma conductor_eq_zero_iff_level_eq_zero : χ.conductor = 0 ↔ n = 0
\end{lstlisting}
An issue with the definition \lean{is\_primitive} is that it equates the levels of of two Dirichlet characters, 
however, this does not imply the types are equal. As an example, consider :
\begin{lstlisting}
lemma dirichlet_character_eq_of_eq {a b : ℕ} (h : a = b) :
dirichlet_character R a = dirichlet_character R b
\end{lstlisting}
It is best avoided to make lemmas about equality of types, however, the tactic \lean{subst} fails here. 
We needed it to deal with further complex statements, such as, \lean{χ} and \lean{χ.asso\_primitive\_dirichlet\_character} 
being the ``same'' when \lean{χ} is primitive. The tactic \lean{congr'} and the lemma \lean{cast\_heq} were useful in 
dealing with such issues. Another alternative we used was to show that they are multiplicatively equivalent 
(bijection which preserves multiplication) : 
\begin{lstlisting}
def equiv {a b : ℕ} (h : a = b) : dirichlet_character R a ≃* dirichlet_character R b
\end{lstlisting}
Traditionally only for primitive characters, our definition of multiplication of characters 
extends to any two characters: 
\begin{lstlisting}
noncomputable def mul {m n : ℕ} (χ₁ : dirichlet_character R n) (χ₂ : dirichlet_character R m) :=
asso_primitive_character(change_level χ₁ (dvd_lcm_left n m) * change_level χ₂ (dvd_lcm_right n m))
\end{lstlisting}
This takes as input characters $\chi_1$ and $\chi_2$ of levels n and $m$ respectively, and returns the primitive 
character associated to $\chi_1' \chi_2'$, where $\chi_1'$ and $\chi_2'$ are obtained by changing the levels 
of $\chi_1$ and $\chi_2$ to $n m$. 
%\subsubsection{Additional properties}
\newline
We need the notion of odd and even characters. A character $\chi$ is odd if $\chi (-1) = -1$, and 
even if $\chi (-1) = 1$. If the target is a commutative ring, then any character is 
either odd or even : 
\begin{lstlisting}
lemma is_odd_or_is_even {S : Type*} [comm_ring S] [no_zero_divisors S] {m : ℕ} 
  (ψ : dirichlet_character S m) : ψ.is_odd ∨ ψ.is_even
\end{lstlisting}
An important consequence is : 
\begin{lstlisting}
lemma asso_odd_dirichlet_character_eval_sub (x : zmod m) (hψ : ψ.is_odd) :
  asso_dirichlet_character ψ (m - x) = -(asso_dirichlet_character ψ x)
lemma asso_even_dirichlet_character_eval_sub (x : zmod m) (hψ : ψ.is_even) :
  asso_dirichlet_character ψ (m - x) = (asso_dirichlet_character ψ x)
\end{lstlisting}
Other important properties include : 
\begin{lstlisting}
/-- Dirichlet characters are continuous. -/
lemma continuous {R : Type*} [monoid R] [topological_space R] {n : ℕ} 
  (χ : dirichlet_character R n) : continuous χ
/-- Associated Dirichlet characters are continuous. -/
lemma asso_dirichlet_character_continuous {R : Type*} [monoid_with_zero R] [topological_space R] 
  {n : ℕ} (χ : dirichlet_character R n) : continuous (asso_dirichlet_character χ) 
/-- Associated Dirichlet characters are bounded. -/
lemma asso_dirichlet_character_bounded {R : Type*} [monoid_with_zero R] [normed_group R] 
  {n : ℕ} [fact (0 < n)] (χ : dirichlet_character R n) : ∃ M : ℝ,
  ‖(⟨asso_dirichlet_character χ, χ.asso_dirichlet_character_continuous⟩ : C(zmod n, R))‖ < M 
\end{lstlisting}
In the last lemma, the norm is the sup norm on $C(\mathbb{Z}/n \mathbb{Z}, R$). 
These are all the ingredients we needed. Let us now define a special Dirichlet character, the Teichmüller character.
\subsubsection{Teichmüller character}
% Given $a \in \mathbb{Z}_p^{\times}$, there exists a unique $(p - 1)^{st}$-root of unity
% $b \in \mathbb{Z}_p$ such that $a \equiv b \text{(mod p)}$.
% This gives us the Teichmüller character
% $\omega : \mathbb{Z}_p^{\times} \xrightarrow[]{} \mathbb{Z}_p^{\times}$. 
The initial effort was to formalise the definition of the Teichmüller character directly. 
However, it was discovered that Witt vectors, and in particular Teichmüller lifts had previously 
been added to \lean{mathlib}. This was used and was very helpful. It reiterates the importance 
of the collaborative spirit of Lean, and of making definitions in the correct generality. 

It is beyond the scope of this text to define Witt vectors and do it justice. For a commutative ring
$R$ and a prime number $p$, one can obtain a ring of Witt vectors $\mathbb{W}(R)$.
When we take $R = \mathbb{Z}/p \mathbb{Z}$, we get 
\begin{lstlisting}
def equiv : $\mathbb{W}$ (zmod p) ≃+* ℤ_[p]
\end{lstlisting}
One also obtains the Teichmüller lift $R \to \mathbb{W} (R)$. Given $r \in R$, 
the 0-th coefficient is $r$, and the other coefficients are 0. This map is a 
multiplicative monoid homomorphism and is denoted \lean{teichmuller}. 

Note that given a multiplicative homomorphism \lean{R →* S} for monoids \lean{R} 
and \lean{S}, one can obtain a multiplicative homomorphism \lean{units R →* units S} 
(by \lean{units.map}). Combining this with the previous two 
definitions, we obtain our definition of the Teichmüller character : 
\begin{lstlisting}
noncomputable abbreviation teichmuller_character_mod_p (p : ℕ) [fact (nat.prime p)] : dirichlet_character ℤ_[p] p :=
  units.map (((witt_vector.equiv p).to_monoid_hom).comp (witt_vector.teichmuller p))
\end{lstlisting}
Often we view this as taking values in a $\mathbb{Q}_p$-algebra $R$, by composing it 
with the algebra map \lean{algebra\_map ℚ\_[p] R}, which identifies elements of $\mathbb{Q}_p$ 
in $R$. \newline
For odd primes $p$, the Teichmüller character is primitive, and \lean{1} otherwise : 
\begin{lstlisting}
lemma is_primitive_teichmuller_character_zmod_p (p : ℕ) [fact (nat.prime p)] (hp : 2 < p) : 
  (teichmuller_character_mod_p p).is_primitive
lemma teichmuller_character_mod_p_two : teichmuller_character_mod_p 2 = 1
\end{lstlisting}
% Composing \lean{equiv} with \lean{to\_zmod\_pow 1} defined in the previous section, we obtain
% the desired homomorphism $\omega$, defined in Lean as :
% \begin{lstlisting}
% noncomputable def Teichmüller_character : 
%   monoid_hom (units ℤ_[p]) ℤ_[p] :=
% {  to_fun := λ a, witt_vector.equiv p (witt_vector.Teichmüller_fun p (padic_int.to_zmod (a : ℤ_[p]))),
%   ..monoid_hom.comp (witt_vector.equiv p).to_monoid_hom
%   (monoid_hom.comp (witt_vector.Teichmüller p)
%     (monoid_hom.comp (padic_int.to_zmod).to_monoid_hom
%       ⟨(coe : units ℤ_[p] → ℤ_[p]), units.coe_one, units.coe_mul⟩)), }
% \end{lstlisting}
% The first two lines of the definition define the function, while the rest proves that it is a
% monoid homomorphism, since it is a composition of monoid homomorphisms.

\subsection{Bernoulli polynomials and the generalized Bernoulli number}
The Bernoulli numbers $B_n$ are generating functions given by $\sum B_n\frac{t^n}{n!}=\frac{t}{e^{t} - 1}$. 
Note that several authors think of Bernoulli numbers $B_n'$ to be defined as $\sum B_n'\frac{t^n}{n!}=\frac{t}{1-e^{-t}}$. 
The difference between these two is : $B_n' = (-1)^n B_n$, with $B_1 = - \frac{1}{2}$.
A reformulation gives :
$$ B_n = 1 - \sum_{k = 0}^{n - 1} {n \choose k} \frac{B_k}{n - k + 1} $$
In \lean{mathlib}, $B_n$ was already defined (by Johan Commelin) as above. However, we needed $B_n'$, which was then defined as :
\begin{lstlisting}
  def bernoulli (n : ℕ) : ℚ := (-1)^n * bernoulli' n
\end{lstlisting}
The Bernoulli polynomials, denoted $B_n(X)$, a generalization of the Bernoulli numbers,
are generating functions $ \sum_{n = 0}^{\infty} B_n(X) \frac{t^n}{n!} = \frac{t e^{tX}}{e^t - 1} $. 
This gives :
$$ B_n (X) = \sum_{i = 0}^n {n \choose i} B_i X^{n - i} $$
We now define the Bernoulli polynomials as :
\begin{lstlisting}
def polynomial.bernoulli (n : ℕ) : polynomial ℚ :=
  ∑ i in range (n + 1), polynomial.monomial (n - i) ((bernoulli i) * (choose n i))
\end{lstlisting}
Here, \lean{polynomial.monomial n a} translates to $a X^n$. A small aspect of this 
naming convention is that if the namespaces for Bernoulli numbers and polynomials are both open 
(which is often the case), in order to use the Bernoulli numbers, one needs to use \lean{\_root\_.bernoulli}. 
We shall use them interchangeably here, when the context is clear. 

%\subsubsection{Properties}
The following properties of Bernoulli polynomials were proved :
\begin{lstlisting}
/-- B_0(X) = 1 -/
lemma polynomial.bernoulli_zero : bernoulli 0 = 1
/-- B_n(0) = B_n -/
lemma polynomial.bernoulli_eval_zero (n : ℕ) : (bernoulli n).eval 0 = bernoulli n
/-- B_n(1) = B_n' -/
lemma polynomial.bernoulli_eval_one (n : ℕ) : (bernoulli n).eval 1 = bernoulli' n
\end{lstlisting}
For a commutative $\mathbb{Q}$-algebra $A$ and $t \in A$, 
$$ \bigg( \sum_{n = 0}^{\infty} B_n(t) \frac{X^n}{n!} \bigg) (e^X - 1) = X e^{tX} : $$
\begin{lstlisting}
theorem polynomial.bernoulli_generating_function (t : A) : 
  mk (λ n, aeval t ((1 / n! : ℚ) • bernoulli n)) * (exp A - 1) = X * rescale t (exp A)
\end{lstlisting}
The theorem \lean{power\_series.mk} (abbreviated as \lean{mk}) defines a formal power series in terms of its
coefficients, that is, $\sum_{n = 0}^{\infty} a_n X^n$ translates to \lean{mk (λ n, a\_n)}. 
The symbol \lean{$\cdot$} represents scalar multiplication of $\mathbb{Q}$ on $\mathbb{Q}$-polynomials. 
The exponential function $e^{x}$, which is defined as a Taylor series expansion,
takes as input $A$, but not $x$. In order to define $e^{tx}$, we need to use
(a ring homomorphism) \lean{rescale y} : for an element $y$ of a commutative semiring $B$, it 
takes a formal power series $f(X)$ over $B$ to $f(yX)$. 

The proof of the last theorem involves equating the $n^{th}$ coefficients of the RHS and the LHS.
After differentiating between n zero and nonzero, one requires the following lemma to complete the
nonzero case :
\begin{lstlisting}
theorem polynomial.sum_bernoulli (n : ℕ) :
  ∑ k in range (n + 1), ((n + 1).choose k : ℚ) • bernoulli k = polynomial.monomial n (n + 1 : ℚ)
\end{lstlisting}
The proof of this theorem follows from the following property of Bernoulli numbers :
\begin{lstlisting}
  theorem sum_bernoulli (n : ℕ):
  ∑ k in range n, (n.choose k : ℚ) * bernoulli k = if n = 1 then 1 else 0
\end{lstlisting}
In order to prove properties of generalized Bernoulli numbers, we needed the following theorem :
\begin{lstlisting}
/-- Bernoulli polynomials multiplication theorem : 
  For k ≥ 1, B_m(k*x) = ∑ i in range k, B_m (x + i / k).  -/
theorem bernoulli_eval_mul' (m : ℕ) {k : ℕ} (hk : k ≠ 0) (x : ℚ) :
  (bernoulli m).eval ((k : ℚ) * x) = k^(m - 1 : ℤ) * ∑ i in range k, (bernoulli m).eval (x + i/k) 
\end{lstlisting}
The proof uses the generating function equality, which makes the proof calculation heavy. It suffices to show 
$$ \sum_n \sum_{i = 0}^{k - 1} \frac{k^{n - 1}}{n!} B_n \bigg(x + \frac{i}{k} \bigg) = (e^{kx} - 1) \sum_n \frac{B_n (kx)}{n!} $$
%We can now define the generalized Bernoulli numbers, the special values $p$-adic $L$-functions take at negative integers.
\subsubsection{Generalized Bernoulli numbers}
Given a primitive Dirichlet character $\chi$ of conductor $f$, the generalized Bernoulli numbers are defined as (section 4.1, \cite{cyc}) 
$ \sum_{n = 0}^{\infty} B_{n,\chi} \frac{t^n}{n!} = \sum_{a = 1}^f \frac{\chi(a)t e^{at}}{e^{ft} - 1} $. 
For any multiple $F$ of $f$, Proposition 4.1 of \cite{cyc} gives us : 
$$ B_{n, \chi} = F^{n - 1} \sum_{a = 1}^{F} \chi (a) B_n \bigg( \frac{a}{F} \bigg) $$
This is much easier to work with, so we use this as our definition, taking $F = f$ :
\begin{lstlisting}
def general_bernoulli_number {S : Type*} [comm_semiring S] [algebra ℚ S] {n : ℕ} 
  (ψ : dirichlet_character S n) (m : ℕ) : S :=
  (algebra_map ℚ S ((ψ.conductor)^(m - 1 : ℤ)))*(∑ a in finset.range ψ.conductor,
  asso_dirichlet_character (asso_primitive_character ψ) a.succ * 
  algebra_map ℚ S ((polynomial.bernoulli m).eval (a.succ / ψ.conductor : ℚ)))
\end{lstlisting}
Contrary to the traditional definition, this is for all characters. The Dirichlet 
character $\psi$ takes values in any commutative $\mathbb{Q}$-algebra, instead of $\mathbb{C}$. 
One had to also explicitly mention that \lean{m - 1} must be taken to have type \lean{ℤ}, since Lean would otherwise infer 
it to have type \lean{ℕ}, which might have caused errors (subtraction on $\mathbb{N}$ 
and $\mathbb{Z}$ are different).

The following are some important properties of generalized Bernoulli numbers : 
\begin{lstlisting}
/-- B_{n,1} = B_n, where 1 is the trivial Dirichlet character of level 1. -/
lemma one_eval {n : ℕ} :
  general_bernoulli_number (1 : dirichlet_character S 1) n = algebra_map ℚ S (bernoulli' n) 
/-- Showing that the definition of general_bernoulli_number is independent of F,
  where F is a multiple of the conductor. -/
lemma eq_sum_bernoulli_of_conductor_dvd {F : ℕ} [hF : fact (0 < F)] (m : ℕ) (h : ψ.conductor|F) : 
  general_bernoulli_number ψ m = (algebra_map ℚ S) (F^(m - 1 : ℤ)) * 
  (∑ a in finset.range F, asso_dirichlet_character ψ.asso_primitive_character a.succ *
  algebra_map ℚ S ((polynomial.bernoulli m).eval (a.succ / F : ℚ))) 
\end{lstlisting}
The latter lemma proves Proposition 4.1 of \cite{cyc}. It is 
false for $F = 0$, since there is no dependency of the LHS on $F$. 
\subsubsection{A special property of generalized Bernoulli numbers}
An important property of these numbers is (from Proposition 7.2 of \cite{cyc}), for $n > 1$, : 
\begin{theorem}\label{thm1}
$$ \lim_{n \to \infty} \frac{1}{dp^{n}} \sum_{0 < a < dp^{n} ; (a, dp) = 1} \chi \omega^{-m} (a) a^{m} = 
(1 - \chi \omega^{-m} (p) p^{m-1}) B_{m, \chi \omega^{-m}} $$
\end{theorem} 
This is formulated in Lean as :
\begin{lstlisting}
theorem sum_lim_even_character : 
  tendsto (λ (n : ℕ), (1 / ↑(d * p ^ n)) • ∑ (i : ℕ) in finset.range (d * p ^ n),
  (asso_dirichlet_character (χ.mul (teichmuller_character_mod_p' p R ^ k))) ↑i * ↑i ^ k) at_top
  (nhds (general_bernoulli_number (χ.mul (teichmuller_character_mod_p' p R ^ k)) k))
\end{lstlisting}
There were two options for the \lean{finset} used in \lean{finset.sum} : \lean{finset.range} or \lean{zmod (d * p\textasciicircum j)}. 
While both are mathematically equivalent, choosing either would create different kinds of coercions. 
We chose the former since it was easier to deal with, as some required lemmas regarding it had been previously formalised.

The proof of this theorem follows from the proof in Lemma 7.11 of \cite{cyc}. Majorly, it equates the two sides modulo $p^n$ for a 
sufficiently large $n$, and uses the fact that $ \lim_{n \to \infty} \frac{1}{dp^{n}} \sum_{0 < a < dp^{n} ; (a, dp) = 1} \chi \omega^{-m} (a) a^{m} = 0 $ :
\begin{lstlisting}
lemma sum_even_character' [nontrivial R] [no_zero_divisors R] [norm_one_class R]
  (na' : ∀ (n : ℕ) (f : (zmod n)ˣ → R), ∥∑ i : (zmod n)ˣ, f i∥ ≤ ⨆ (i : (zmod n)ˣ), ∥f i∥)
  (na : ∀ (n : ℕ) (f : ℕ → R), ∥ ∑ (i : ℕ) in finset.range n, f i∥ ≤ ⨆ (i : zmod n), ∥f i.val∥)
  [fact (0 < m)] {k : ℕ} (hk : 1 < k) (hχ : χ.is_even) (hp : 2 < p) :
  tendsto (λ n, ∑ (i : (zmod (d * p^n))ˣ), ((asso_dirichlet_character
  (dirichlet_character.mul χ (teichmuller_character_mod_p' p R^k))) i * i^(k - 1))) 
  at_top (nhds 0) 
\end{lstlisting}
Notice that this sum is over the \lean{fintype} \lean{(zmod (d * p\textasciicircum n))ˣ}.

The formalisation is very calculation intensive, since there are multiple 
coercions to be dealt with. Also, terms needs to be moved around to be multiplied, deleted and cancelled. Unfortunately, there is no tactic 
that takes care of these elementary but lengthy calculations.

This is used heavily in the proof of the special values of the $p$-adic $L$-functions theorem (cite). 
We shall discuss its proof in Section 4 (link).

\section{Construction of the $p$-adic $L$-function}
\label{section3}
\subsection{Profinite spaces}
\subsubsection{Density of locally constant functions}
In Proposition 12.1 of \cite{cyc}, Washington defines the $p$-adic integral on $C(X, \mathbb{C}_p)$,
the Banach space of continuous functions from a profinite space X to $\mathbb{C}_p$.
This is an extension of a function defined on a dense subset of $C(X, \mathbb{C}_p)$, the
locally constant functions from X to $\mathbb{C}_p$. In fact, for any compact
Hausdorff totally disconnected space X and a commutative
normed ring A, $LC(X, A)$ is a dense subset of $C(X, A)$. 

The mathematical proof is the following : For $f \in C(X, A)$, we want to prove that,
for any $\epsilon > 0$, we have $R = \bigcup_{x \in R} B(x, \epsilon)$. Since X is compact,
one can find finitely many open sets $U_1, \dots, U_n$ such that $U_i = f^{-1}(B(x_i, \epsilon))$
for $x_1, \dots, x_n$ in R. One needs the fact that compact Hausdorff totally disconnected spaces
have a clopen basis. We then find a finite set of disjoint clopen sets $C_1, \dots, C_m$ which form
a basis, such that each $C_j$ is contained in some $U_i$.
Then, we pick elements $a_1, \dots, a_m$ in $C_1, \dots, C_m$, and construct the locally constant
function $g(x) := \sum_{j = 1}^m f(a_j) \chi_{C_j}(x)$, where $\chi_U$ is the characteristic
(locally constant) function taking value 1 on every element of U and 0 otherwise. It then follows
that $|| f - g || = sup_{x \in X} ||f(x) - g(x)|| < \epsilon$, as required. 

formalising this took about 500 lines of code. Let us show that locally compact Hausdorff
totally disconnected spaces have a clopen basis :

\begin{lstlisting}
lemma loc_compact_Haus_tot_disc_of_zero_dim {H : Type*} [topological_space H] 
[locally_compact_space H] [t2_space H] [totally_disconnected_space H] :
  is_topological_basis {s : set H | is_clopen s}
\end{lstlisting}

The mathematical proof is : We want to show that for every $x \in H$ and open set $U$ such that
$x \in U$, there exists a clopen set $C$ such that $x \in C$ and $C \subseteq U$. Since $H$ is a
locally compact space, we can find a compact set $s$ such that $x \in \text{(interior s)}$ and
$s \subseteq U$. The following lemma states that, every member of an open set in a compact Hausdorff 
totally disconnected space is contained in a clopen set contained in the open set. :
\begin{lstlisting}
lemma compact_exists_clopen_in_open {x : α} {U : set α} (is_open : is_open U) 
  (memU : x ∈ U) : ∃ (V : set α) (hV : is_clopen V), x ∈ V ∧ V ⊆ U
\end{lstlisting}
This implies that we can find a clopen set $V \subseteq \text{(interior s)}$ of $s$, with $x \in V$. 
Since $V$ is closed in $s$(compact, hence closed), $V$ is closed in $H$. Since
$V \subseteq \text{(interior s)}$ is open in $s$, hence in (interior $s$), $V$ is open in $H$, thus
we are done. 

This turned out to be harder to formalise than expected. Lean gives a subset $V$ of s \newline (\lean{compact\_space s ↔ is\_compact (s:set H)}) 
the type \lean{V:set s}; however, Lean does not recognize $V$ as a subset of $H$. As a result, I must construct \lean{V':set H} 
to be the image of $V$ under the closed embedding \lean{coe:s → H}. This process must be repeated each time a subset of $H$, 
which is also a topological subspace, is considered. Finally, it must be shown that all these coercions match up in the big 
topological space $H$.

%%and $s$ has type \lean{set H}, but does not recognize $V$ as a subset of  This is because $s$, which is of type
%%\lean{s : set H} also has the property \lean{is\_compact (s:set H)}. This is equivalent to saying
%%that $s$ is a compact space, that is, \lean{compact\_space (set.univ:set s)}, where
%%\lean{(set.univ:set s)} is simply $s$ viewed as a set of itself, instead of a topological space.
%%Now, if we have $V$ to be a subset of $s$ of type \lean{V:set s}, Lean does not recognize it as
%%a subset of $H$. We construct \lean{V':set H} to be the image of $V$ under the closed embedding \lean{coe:s → H}. This process must be repeated each time we consider a
%%subset as a topological space.

\subsubsection{Clopen sets of the $p$-adic integers}
As mentioned before, $\mathbb{Z}_p$ is a profinite space. Since it is the inverse limit of finite
discrete topological spaces $\mathbb{Z}/p^n \mathbb{Z}$ for all $n$, it has a clopen basis of the
form $U_{a,n} := proj_n ^{-1} (a)$ for $a \in \mathbb{Z}/p^n \mathbb{Z}$, where $proj_n$ is the
canonical projection ring homomorphism \lean{to\_zmod\_pow n:$\mathbb{Z}$\_[p] →+* zmod (p $\hat{}$ n)}. 

We first define the collection of sets $(U_{a,n})_{a,n}$ :
\begin{lstlisting}
  def clopen_basis : set (set ℤ_[p]) := 
  {x : set ℤ_[p] | ∃ (n : ℕ) (a : zmod (p^n)),
  x = set.preimage (padic_int.to_zmod_pow n) {a} }
\end{lstlisting}

We now want to show that \lean{clopen\_basis} forms a topological basis and that every element is
clopen :
\begin{lstlisting}
  theorem clopen_basis_clopen : 
    topological_space.is_topological_basis (clopen_basis p) ∧
    ∀ x ∈ (clopen_basis p), is_clopen x
\end{lstlisting}
The mathematical proof is to show that for any $\epsilon$-ball, one can find $U_{a,n}$ inside it.
This is true because, given $n \in \mathbb{N}$ and $x \in \mathbb{Z} / p^n \mathbb{Z}$, the preimage of $x$ 
under \lean{to\_zmod\_pow n} is the same as the ball centered at $x$ (now considered as an element of $\mathbb{Z}_p$) with radius $p^{1 - n}$ :
\begin{lstlisting}
  lemma preimage_to_zmod_pow_eq_ball (n : ℕ) (x : zmod (p^n)) : 
  (to_zmod_pow n) ⁻¹' {(x : zmod (p^n))} = 
    metric.ball (x : ℤ_[p]) ((p : ℝ) ^ (1 - (n : ℤ)))
\end{lstlisting}

Notice that, in the RHS, we must specify \lean{n:ℤ}. If that is not done, Lean interprets \lean{1 - n:ℕ}. This is not the same as 
\lean{1 - n:ℤ}, since subtraction is defined differently for the naturals. 
Proving this lemma was fairly straightforward using the expansion of a $p$-adic integer, that is, every
$a \in \mathbb{Z}_p$ can be written as $\sum_{n = 0}^{\infty} a_n p^n$, with $a_n \in \mathbb{Z}/p^n \mathbb{Z}$.
Approximating $a$ by $\sum_{n = 0}^{m} a_n p^n$ is done by the function \lean{appr:$\mathbb{Z}$\_p → $\mathbb{N}$ → $\mathbb{N}$}.
Note that \lean{appr} returns a natural number, with $a_n$ being the smallest natural number in the
$\mathbb{Z}/p^n \mathbb{Z}$ equivalence class. This turned out to be very useful, along with the
following lemmas :

\begin{lstlisting}
  lemma appr_spec (n : ℕ) (x : ℤ_[p]) :  
    x - appr x n ∈ (ideal.span {p^n} : ideal ℤ_[p])
  lemma has_coe_t_eq_coe (x : ℤ_[p]) (n : ℕ) :
  (((appr x n) : zmod (p^n)) : ℤ_[p]) = ((appr x n) : ℤ_[p])
\end{lstlisting}

In the latter lemma, the LHS is a coercion of \lean{appr x n}, which has type \lean{$\mathbb{N}$}, to \lean{$\mathbb{Z}$\_p}. 
The RHS is a coercion of \lean{appr x n} to \lean{zmod (p $\hat{}$ n)} to \lean{$\mathbb{Z}$\_p}. 
This statement is not true in general, that is, given any natural number $n$, it is not true that the lift of $n$ to $\mathbb{Z}_p$ 
is the same as the composition of its lift to $\mathbb{Z}/p^n \mathbb{Z}$ and $\mathbb{Z}_p$. 
It works here because the coercion from $\mathbb{Z}/p^n \mathbb{Z}$ to $\mathbb{Z}_p$ is not the canonical lift.
It is a composition of a coercion from $\mathbb{Z}/p^n \mathbb{Z}$ to $\mathbb{N}$, which takes
$a \in \mathbb{Z}/p^n \mathbb{Z}$ to the smallest natural number in its
$\mathbb{Z}/p^n \mathbb{Z}$ equivalence class. 

One can similarly show that the sets $U_{b, a, n} := proj_1^{-1} (b) \times proj_{2,n} ^{-1} (a)$ form a clopen basis for 
$\mathbb{Z} / d \mathbb{Z} \times \mathbb{Z}_p$, where $proj_1$ is the first canonical projection on $b \in \mathbb{Z} / d \mathbb{Z}$ 
and $proj_{2,n}$ the composition of the second projection on $a \in \mathbb{Z}_p$ with $proj_n$ descried above. We call this set 
\lean{clopen\_basis' p d}. For the sake of simplicity, we shall discuss the case $d = 1$ in this article.

\subsection{$p$-adic distributions and measures}
In this section, $X = \varprojlim_{i \in \mathbb{N}} X_i$ denotes a profinite space with $X_i$ finite and
projection maps $\pi_i : X \xrightarrow[]{} X_i$ and surjective maps
$\pi_{ij} : X_i \xrightarrow[]{} X_j$ for all $i \ge j$. We use $G$ to denote an abelian group,
$A$ for a commutative normed ring, $R$ for a commutative complete normed ring having a coercion from $\mathbb{Z}_p$, 
and $LC(X,Y)$ for the space of locally constant functions from $X$ to $Y$. 
We fix a prime $p$ and an integer $d$ such that $gcd(d, p) =1$. 

We begin by defining distributions on profinite sets. In Section 12.1 of \cite{cyc}, Washington
gives 3 equivalent definitions of a distribution :
\begin{enumerate}
  \item A system of maps $\phi_i : X_i \xrightarrow[]{} G$ such that $\forall i \ge j$,
  $$ \phi_j(x) = \sum_{\pi_{ij}(y) = x} \phi_i(y) $$
  \item A $G$-linear function $\phi : LC(X, G) \xrightarrow[]{} G$.
  \item A finitely additive function from the compact open sets of $X$ to $G$.
\end{enumerate}

Since switching between definitions is cumbersome, and(at that point of time), \lean{mathlib}
had no notion of thinking about profinite sets as inverse limits of finite sets, we chose to work
with the second definition. However, this is already a Type, hence there is no need to redefine it.

The topology on $C(X, A)$ comes from its normed group structure induced by the norm on $A$ :
$|| f - g || = sup_{x \in X} || f(x) - g(x) ||$. In fact, this topology is the same as the 
topology defined on bounded functions on $X$, since $X$ is a compact space. Since the API for bounded 
continuous functions on compact spaces was developed at around the same time (created by Oliver Nash), 
we simply used the existing lemmas along with the equivalence 
\lean{bounded\_continuous\_function.equiv\_bounded\_of\_compact}. 

While showing that, $\forall f \in C(X, A)$, $||f|| = 0 \implies f = 0$, it suffices to show 
$||f|| \le 0 \implies \forall x \in X, ||f(x)|| \le 0$. We then use the following lemma, which 
requires a nonempty assumption on $X$ :
\begin{lstlisting}
  theorem cSup_le_iff {α : Type*} [conditionally_complete_lattice α] 
  {s : set α} {a : α} (hb : bdd_above s) (ne : nonempty s) : 
  Sup s ≤ a ↔ (∀b ∈ s, b ≤ a)
\end{lstlisting}

The case that $X$ is empty is separately (and trivially) solved. 

% Ideally, there is no need to define \lean{distribution'}, since there are no additional
% properties it satisfies which linear maps do not. A database needs to be built for every definition
% made, which can be costly. Hence, in the final version, this definition will probably be
% removed. 
We can now define $p$-adic measures. Measures are bounded distributions. Note that the $p$-adic measures
are not to be confused with measures arising from measure theory. The key difference lies in the
fact that the clopen sets of a profinite space do not, in general, form a $\sigma$-algebra. 

\begin{lstlisting}
  def measures [nonempty X] :=
  {φ : (locally_constant X A) →ₗ[A] A // ∃ K : ℝ, 0 < K ∧ 
  ∀ f : (locally_constant X A), $\lVert$φ f$\rVert$ ≤ K * $\lVert$inclusion X A f$\rVert$ }
\end{lstlisting}

The boundedness of the distribution is needed to make the measure continuous :
\begin{lstlisting}
  lemma integral_cont (φ : measures X A) : continuous ⇑φ
\end{lstlisting}

The proof is straightforward : for $b \in LC(X, A)$, given $\epsilon > 0$, there exists a
$\delta > 0$ such that for all $a \in LC(X, A)$ with $|| b - a || < \delta$,
$|| \phi(a) - \phi(b) || < \epsilon$. Since $\phi$ is a measure, it suffices to prove that
$ K * ||inclusion (a - b)|| < \epsilon $. Choosing $\delta  = \epsilon / K$ gives the desired
result. 

The Bernoulli measure is an essential $p$-adic measure. We make a choice of an integer $c$ with
$gcd(c,dp) = 1$, and $c^{-1}$ is an integer such that $c c^{-1} \equiv 1 \text{ mod } dp^{2n+1}$.
For $x_n \in (\mathbb{Z} / dp^{n +1} \mathbb{Z})^{\times}$, the (first) Bernoulli measure is defined by
$$ E_{c,n}(x_n) = B_1 \bigg( \bigg\{ \frac{x_n}{dp^{n + 1}} \bigg\} \bigg) -
  cB_1 \bigg( \bigg\{ \frac{c^{-1}x_n}{dp^{n + 1}} \bigg\} \bigg) $$

The system $(E_{c,n})_{n \in \mathbb{N}}$ forms a distribution according to the first definition
given above. We want to get an equivalent reformulation in terms of the second definition.
We know that, since $X$ is compact, every locally constant function can be written in terms of a
finite sum of a characteristic function of a basis element multiplied by a constant. Since $X$ is
profinite, from the previous section, we know that there exists a clopen basis of the form
\lean{set.preimage (padic\_int.to\_zmod\_pow n) {a}} for $a \in\mathbb{Z}/dp^{n} \mathbb{Z}$. 
For the sake of simplicity, let us assume $d = 1$. Thus, for a
clopen set $U_{a,n} := $ \lean{set.preimage (padic\_int.to\_zmod\_pow n) {a}}, we define
$$ E_c (\chi_{U_{a,n}}) = E_{c,n} (a) $$
In Lean, this translates to (note that \lean{fract x} represents the fractional part of $x$) :
\begin{lstlisting}
def E_c (hc : gcd d p = 1) := 
  λ (n : ℕ) (a : (zmod (d * (p^n)))), fract ((a : ℤ) / (d*p^(n + 1))) 
  - c * fract ((a : ℤ) / (c * (d*p^(n + 1)))) + (c - 1)/2
\end{lstlisting}

% The tactic \lean{classical.some} makes an arbitrary choice of an element from a space, if the space
% is nonempty, and \lean{classical.some\_spec} lists down the properties of this random element
% coming from the space. In particular, given \lean{U:clopen\_basis p}, we obtain an $n$ and $a$ 
% such that $U = U_{a,n}$. \lean{bernoulli\_measure} is then defined to be the set of $R$-linear maps 
% from \lean{locally\_constant $\mathbb{Z}$\_p R} to \lean{R} which, when evaluated at any clopen basis set 
% gives the same value as $E_c$ on the set. 
%Also, it is only at this point that
%%we need to think of $\mathbb{Z}_p$ as a compact, Hausdorff,
%%totally disconnected space. 

\subsection{The Bernoulli measure}
Throughout this section, we assume that $R$ is a normed commutative ring which is a $\mathbb{Q}_p$-algebra, 
$\mathbb{Q}$-algebra, and has a nonarchimedean norm, that is, for any finite set of elements 
$(r_i)_{i = 1}^n$ of $R$, $\sum_{i = 1}^n \parallel r_i \parallel \le \sup \parallel r_i \parallel$.

The original plan was to define a set of the form : 
\begin{lstlisting}
def bernoulli_measure (hc : c.gcd p = 1) :=
 {x : locally_constant (zmod d × ℤ_[p]) R →ₗ[R] R | ∀ (n : ℕ) 
    (a : zmod (d * (p^n))), x (char_fn R (is_clopen_clopen_from p d n a)) = 
    (algebra_map ℚ R) (E_c p d hc n a) }
\end{lstlisting}

and to show that it is nonempty. However, this is quite a roundabout way, since one then has to use 
\lean{classical.some} to extract the Bernoulli measure. We use an elegant way to tackle the problem. 

First, we define \lean{eventually\_constant\_seq} to be the type of sequences satifying : 
\begin{lstlisting}
/-- A sequence has the `is_eventually_constant` predicate if all the elements of the sequence are eventually the same. -/
def is_eventually_constant {α : Type*} (a : ℕ → α) : Prop :=
 { n | ∀ m, n ≤ m → a (nat.succ m) = a m }.nonempty
\end{lstlisting}

Then, given a locally constant function $f$ from $\mathbb{Z}/d \mathbb{Z} \times \mathbb{Z}_p$ to $R$, 
we define the eventually constant sequence \lean{g} to be : 
$$ g(n) = \sum_{a \in \mathbb{Z}/(d*p^n) \mathbb{Z}} f(a) E_{c, n}(a) $$ 
for all natural numbers $n$. We shall look into the proof of $g$ being eventually constant later. We now define the Bernoulli 
distribution to be the limit of this sequence $g$. 

The proof of this distribution being closed under addition and scalar multiplication follows easily from these definitions and lemmas : 
\begin{lstlisting}
/-- The smallest number `m` for the sequence `a` such that `a n = a (n + 1)` for all `n ≥ m`. -/
noncomputable def sequence_limit_index' {α : Type*} (a : @eventually_constant_seq α) : ℕ :=
  Inf { n | ∀ m, n ≤ m → a.to_seq m.succ = a.to_seq m }

/-- The limit of an `eventually_constant_seq`. -/
noncomputable def sequence_limit {α : Type*} (a : @eventually_constant_seq α) :=
  a.to_seq (sequence_limit_index' a)

lemma sequence_limit_eq {α : Type*} (a : @eventually_constant_seq α) (m : ℕ)
  (hm : sequence_limit_index' a ≤ m) : sequence_limit a = a.to_seq m
\end{lstlisting}

Now, given a locally constant function \lean{f : locally\_constant (units (zmod d) × units ℤ\_[p]) R}, 
the \lean{bernoulli\_measure} is given by : 
\begin{lstlisting}
  bernoulli_distribution p d R (loc_const_ind_fn _ p d f)
\end{lstlisting}
where \lean{loc\_const\_ind\_fn} is a locally constant function on $\mathbb{Z}/d \mathbb{Z} \times \mathbb{Z}_p$ 
that takes value $f$ on the units of the domain, and 0 otherwise. We shall skip the proof that this function is 
locally constant, because it is long and cumbersome. For every open set $s$, one must look at the case when 0 is 
contained in $s$ separately. We (prove and) use the fact that \lean{coe : units (zmod d) × units ℤ\_[p] → (zmod d) × ℤ\_[p]} 
is an open embedding heavily. 

We must now prove that \lean{bernoulli\_measure} is indeed a measure, that is, it is bounded. The bound we choose is 
$1 + \parallel c \parallel + \parallel \frac{c - 1}{2} \parallel$. The proof is as follows : let BD denote the Bernoulli 
distribution, and $\phi$ denote \lean{loc\_const\_ind\_fn}. We want to show that : 
$$ \parallel BD (\phi (f)) \parallel \le K \parallel inclusion (f) \parallel $$
where $K$ is the constant given above. We know that, one can find an $n$ such that 
$$\phi (f) = \sum_{a \in \mathbb{Z}/d \mathbb{Z} \times \mathbb{Z} /p^n \mathbb{Z}} \phi(f) (a) \dot{} \chi_{n,a}$$

Since $BD$ is a linear map, it suffices to show that 
$\parallel BD (\phi (f)(a) \chi_{n, a}) \parallel \le K \parallel inclusion f \parallel$ for some $a$ (the supremum is achieved 
since the set is finite). If $a$ is not a unit, $\phi (f) (a) = 0$; by using the linearity of $BD$, we are done. 
In the case that $a$ is a unit, it suffices to prove that $\parallel BD(\chi_{n, a}) \parallel \le K$, and 
$\parallel \phi (f) (a) \parallel \le \parallel inclusion f \parallel$. Both of these are easily verified, so we are done. 

The implementation is similar, and is heavily dependent on the following lemma : 
\begin{lstlisting}
lemma loc_const_eq_sum_char_fn (f : locally_constant ((zmod d) × ℤ_[p]) R) 
  (hd : d.gcd p = 1) : ∃ n : ℕ, 
  f = ∑ a in (finset.range (d * p^n)), 
    f(a) • char_fn R (is_clopen_clopen_from p d n a)
\end{lstlisting}

The machinery used in this proof is similar to the one used to prove that $g$ is eventually constant. Let us have a look at the latter first. 

We must first take a look at discrete quotients. The discrete quotient on a topological space is given by an equivalence relation such 
that all equivalence classes are clopen : 
\begin{lstlisting}
structure (X : Type*) [topological_space X] discrete_quotient :=
 (rel : X → X → Prop)
 (equiv : equivalence rel)
 (clopen : ∀ x, is_clopen (set_of (rel x)))
\end{lstlisting}

The last statement translates to, $\forall x \in X, \{ y | y \sim x \}$ is clopen. 
Given two discrete quotients $A$ and $B$, $A \le B$ means that $\forall x,y \in X$, 
$x \sim_{A} y \implies x \sim_{B} y$. 

Any locally constant function induces a discrete quotient, since each of its fibers is clopen : 
\begin{lstlisting}
def discrete_quotient : discrete_quotient X :=
{ rel := λ a b, f b = f a,
  equiv := ⟨by tauto, by tauto, λ a b c h1 h2, by rw [h2, h1]⟩,
  clopen := λ x, f.is_locally_constant.is_clopen_fiber _ }
\end{lstlisting}

We now define a function : 
\begin{lstlisting}
def F : ℕ → discrete_quotient (zmod d × ℤ_[p]) := λ n, 
  ⟨λ a b, to_zmod_pow n a.2 = to_zmod_pow n b.2 ∧ a.1 = b.1, _, _⟩
\end{lstlisting}

In other words, for $a = (a_1, a_2)$ and $b = (b_1, b_2)$ in $\mathbb{Z}/d \mathbb{Z} \times \mathbb{Z}_p$, $F(n)$ represents the relation 
$$ a \sim b \iff a_2 (\text{mod } p^n) = b_2 (\text{mod } p^n) \and a_1 = b_1 $$
Then, given a locally constant function $f$ on $\mathbb{Z}/d \mathbb{Z} \times \mathbb{Z}_p$, we have :
\begin{lstlisting}
lemma factor_F (hd : d.gcd p = 1) (f : locally_constant (zmod d × ℤ_[p]) R) :
  ∃ N : ℕ, F N ≤ discrete_quotient f
\end{lstlisting}

\lean{factor\_F} states that, for $N$ large enough, the fibers of $f$ mod $p^N$ are contained in the basic clopen sets of $p^N$. 
Here is the proof of \lean{factor\_F} : Since $X$ is compact, there exists a finite set $t$ in $R$ such that $X \subseteq \cup_{i \in t} f^{-1} (i)$. 
Given an open set $U$ of $\mathbb{Z}/d \mathbb{Z} \times \mathbb{Z}_p$, we now define the \lean{bound\_set} of $U$ to be 
\newline $\{ n \in \mathbb{N} \mid \forall a \in U, U_{n, (\text{a : zmod }p^n)} \subseteq U \}$. The \lean{bound} of $U$ is then defined to be the infimum of the \lean{bound\_set U}. 
Let $n$ be the supremum of \lean{bound} of $f^{-1} (i)$ for all $i \in t$. This is the required \lean{N}. 

The proofs of both $g$ being eventually constant now follows. We want to show : 
$$ \exists N, \forall m \ge N, \sum_{a \in \mathbb{Z}/d*p^{m + 1} \mathbb{Z}} f(a) E_{c,m + 1}(a) = \sum_{a \in \mathbb{Z}/d*p^{m} \mathbb{Z}} f(a) E_{c,m}(a) $$
The $N$ we choose is \lean{classical.some (factor\_F f) + 1}. We also define the following : 
\begin{lstlisting}
/-- Given `a ∈ zmod (d * p^n)`, and `n < m`, the set of all `b ∈ zmod (d * p^m)` such that `b = a mod (d * p^n)`. -/
def equi_class (n m : ℕ) (h : n ≤ m) (a : zmod (d * p^n)) :=
 {b : zmod (d * p^m) | (b : zmod (d * p^n)) = a}
\end{lstlisting}
Then, we have the following lemma :
\begin{lstlisting}
lemma succ_eq_bUnion_equi_class : zmod' (d*p^(m + 1)) = (zmod' (d*p^m)).bUnion
  (λ a : zmod (d * p ^ m), set.to_finset (equi_class m (m + 1)) a) 
\end{lstlisting}
This lemma says that any element of $\mathbb{Z}/dp^{m + 1} \mathbb{Z}$ comes from \lean{equi\_class m (m + 1) b} for some $b \in \mathbb{Z}/dp^m \mathbb{Z}$. 
Notice that we use \lean{zmod'} instead of \lean{zmod}, since that has type \lean{finset}, that is, the property of \lean{zmod} being finite is encoded in it. This 
is needed since we are working with finite sums, hence Lean demands elements of type \lean{finset} instead of \lean{set}. 

The proof is now complete with the following lemma :
\begin{lstlisting}
lemma E_c_sum_equi_class (x : zmod (d * p^m)) :
  ∑ (y : zmod (d * p ^ (m + 1))) in (λ a : zmod (d * p ^ m), 
  set.to_finset ((equi_class m (m + 1)) a)) x, (E_c (m + 1) y) = E_c m x
\end{lstlisting}
which says that, for $x \in \mathbb{Z}/dp^m \mathbb{Z}$, $E_{c, m} (x) = \sum_{y}' E_{c, m + 1} (y)$,\newline where $y$ belongs to \lean{equi\_class m (m + 1) x}. 

Finally, we turn to the proof of \lean{loc\_const\_eq\_sum\_char\_fn}. We want to show that, for any locally constant function $f$ from 
$\mathbb{Z}/d \mathbb{Z} \times \mathbb{Z}_p$ to $R$, 
$$\exists n, f = \sum_{a \in \mathbb{Z}/dp^n \mathbb{Z}} f(a) \chi_{n, a}$$
We choose $n$ to be \lean{classical.some factor\_F f}. The proof now follows easily, since each element belongs to exactly one clopen set of level $n$. One must go 
between elements of $\mathbb{Z}/d \mathbb{Z} \times \mathbb{Z}_p$ and $\mathbb{Z}/dp^n \mathbb{Z}$. This requires use of multiple coercions, which makes the proof lengthy. 

Notice that \lean{bernoulli\_distribution} takes locally constant functions on $\mathbb{Z}/d \mathbb{Z} \times \mathbb{Z}_p$, 
while \newline \lean{bernoulli\_measure} takes locally constant functions on $\mathbb{Z}/d \mathbb{Z}^* \times \mathbb{Z}_p^*$. This had to be done since our clopen basis was defined on 
$\mathbb{Z}/d \mathbb{Z} \times \mathbb{Z}_p$, and while it is easy to show the same results for the units on paper, it requires a bit of work in Lean.

\subsection{$p$-adic integrals and the $p$-adic $L$-function}
\subsubsection{$p$-adic Integrals}
The last piece in the puzzle is the $p$-adic integral. We use the same notation as in the previous
section. Given a measure $\mu$, and a function $f \in LC(X, R)$,
$\int f d\mu := \mu(f)$. As in Theorem 12.1 of \cite{cyc}, this can be extended to a
continuous $R$-linear map :
$$ \int_X f d\mu : C(X, R) \xrightarrow[]{} R $$

This follows from the fact that $LC(X, R)$ is dense in $C(X, R)$; as a result, the map 
\newline $inclusion : LC(X, R) \xrightarrow[]{} C(X, R)$
is \lean{dense\_inducing}, that is, it has dense range and the topology on $LC(X, R)$ is the one
induced by \lean{inclusion} from the topology on $C(X,R)$. 

For the linearity of the map, we use \lean{dense\_range.induction\_on$_2$}, which states that, given a map $e : \alpha \to \beta$ which has dense range, 
and a property $p$ (taking two elements as input), in order for any two elements of $\beta$ to satisfy $p$, it is sufficient to show that any two elements 
in the range of $e$ satisfy $p$; and, the set of elements satifying $p$ is closed with respect to the topology of $\beta$ :
\begin{lstlisting}
  lemma dense_range.induction_on₂ {α β : Type*} [topological_space β] {e : α → β} 
  {p : β → β → Prop} (he : dense_range e) (hp : is_closed {q:β×β | p q.1 q.2}) 
  (h : ∀a₁ a₂, p (e a₁) (e a₂)) (b₁ b₂ : β) : p b₁ b₂
\end{lstlisting}

In particular, for every continuous function $f$, we can take the property $p$ to be preservation of addition (and scalar multiplication respectively) under 
$\mu (f)$, and \lean{inclusion} to be the map with dense range. The first condition is satisfied due to the following lemma :
\begin{lstlisting}
  lemma is_closed_eq [t2_space α] {f g : β → α} (hf : continuous f) 
  (hg : continuous g) : is_closed {x:β | f x = g x}
\end{lstlisting}

The second condition follows easily due to the linearity of the measure and the map \lean{inclusion}. 

The continuity of the extension of the integral follows from the fact that every measure $\mu$ is uniformly continuous. Uniform continuity is a 
product of the boundedness of the measure : We want to show that, for any measure $\phi$, given an $\epsilon > 0$, $\exists \delta > 0$ such that 
for any $a, b \in LC(X, R)$, with $||a - b|| < \delta$, $|| \phi (a) - \phi (b) || < \epsilon$. Assuming that the constant in the definition of $\phi$ 
is $K$, it is clear that $\epsilon / K$ is the required $\delta$. This is the proof of the following lemma :
\begin{lstlisting}
  lemma uniform_continuous (φ : measures X A) : uniform_continuous ⇑φ 
\end{lstlisting}

\subsubsection{Construction}
There are several possible definitions for the $p$-adic $L$-functions (fixing an embedding of
$\mathbb{\bar{\mathbb{Q}}}$ into $\mathbb{C}_p$), including :
\begin{enumerate}{}{}
  \item (Theorem 5.11, \cite{cyc}) The $p$-adic meromorphic function $L_p(s, \chi)$ on
  \newline $\{ s \in \mathbb{C}_p | |s| < p \}$ obtained by analytic continuation, such that
  $$ L_p (1 - n, \chi) = -(1 - \chi \omega^{-n}(p)p^{n - 1}) \frac{B_{n, \chi \omega^{-n}}}{n} $$
  for $n \ge 1$.
  \item (Proof of Theorem 5.11, \cite{cyc})
  $L_p(s, \chi) = \sum_{a = 1, p\nmid a}^F \chi(a)H_p(s, a, F)$, where $H_p (s, a, F)$ is a 
  meromorphic function satifying 
  \newline $H_p(1 - n, a, F) = - \frac{F^{n - 1}\omega^{-n}(a)}{n} B_n \big( \frac{a}{F} \big)$ for all 
  natural numbers $n$.
  \item (Theorem 12.2, \cite{cyc}) For $s \in \mathbb{Z}_p$, and Dirichlet character $\chi$ with
  conductor $d p^m$, with $gcd (d, p) = 1$ and $m \ge 0$, for a choice of $c \in \mathbb{Z}$
  with $gcd (c, dp) = 1$ :
  $$ (1 - \chi(c)<c>^{s+1}) L_p(-s, \chi) = \int_{(\mathbb{Z}/d \mathbb{Z})^{\times} \times \mathbb{Z}_p^{\times}}
  \chi \omega^{-1}(a) <a>^s dE_c $$
  where $<a> = \omega^{-1}(a) a$, and $b^s = exp (log_p (b))$ (the exponential and logarithm are defined in 
  terms of power series expansions).
\end{enumerate}

It is beyond the scope of this article to explain all the notation in the points above. I chose to
define the $p$-adic $L$-function as a reformulation of (3). This is because it is the most optimal
definition that helps with stating the Iwasawa Main Conjecture. 

Instead of using the variable $s$ (which takes values in a subset of $\mathbb{C}_p$), we choose to use an element of the weight space. We replace
$<a>^s$ with \lean{w:weight\_space A}. The advantage is that our $p$-adic $L$-function can now be defined over a more general space. 

Given a primitive Dirichlet character $\chi$ of character $dp^m$ with $gcd(d, p) = 1$ and $m \ge 0$,
we now define the $p$-adic $L$-function to be :
$$ L_p(w, \chi) := \int_{(\mathbb{Z}/d \mathbb{Z})^{\times} \times \mathbb{Z}_p^{\times}}
\chi \omega^{p - 2} (a) w \text{    } dE_c $$

\begin{lstlisting}
  def p_adic_L_function (hc : gcd c p = 1) :=
  integral (units (zmod d) × units ℤ_[p]) R _ 
  (bernoulli_measure_of_measure p d R hc)
⟨(λ (a : (units (zmod d) × units ℤ_[p])), ((pri_dir_char_extend p d R) a) *
  (inj (Teichmüller_character p a.snd))^(p - 2) * (w.to_fun a : R)), 
    cont_paLf p d R inj w ⟩
\end{lstlisting}

Note that we have absorbed the constant term given in (3). This was done because Theorem 12.2 lets $L_p(-s, \chi)$ take values in $\mathbb{C}_p$. 
In a general ring $R$, as we have chosen, division need not exist. One would then need the factor to be a unit, which may not always happen 
(for example, consider $R = \mathbb{Q}_p$). Thus, our $p$-adic $L$-function differs from the original by a constant factor. 
However, this factor appears as it is in the Iwasawa Main Conjecture, and can be easily removed if one assumes $R$ to have division. 

Lean (implicitly) interprets the placeholder \lean{\_} as a proof that 
\newline $(\mathbb{Z}/d \mathbb{Z})^{\times} \times \mathbb{Z}_p^{\times} = $ \lean{units (zmod d) × units $\mathbb{Z}$\_[p]} is nonempty. 
Note that \lean{pri\_dir\_char\_extend} extends $\chi$
from $(\mathbb{Z}/ dp^m \mathbb{Z})^{\times}$ to $(\mathbb{Z}/ d \mathbb{Z})^{\times} \times \mathbb{Z}_p^{\times}$ via the restriction map. 

By construction, the last term given as input to \lean{integral} has type \newline \lean{C((units (zmod d) × units $\mathbb{Z}$\_[p]),R)}. 
This is the term in angular brackets \lean{⟨\_, \_⟩}, the former is the integrand, and the latter is a proof that the integrand is continuous : 

\begin{lstlisting}
  lemma cont_paLf : continuous (λ (a : (units (zmod d) × units ℤ_[p])),
  ((pri_dir_char_extend p d R) a) * (inj (Teichmüller_character p (a.snd)))^(p - 2)
  * (w.to_fun a : R))
\end{lstlisting}

What remains to be proved is that $f$ is invariant with respect to $c$. 
Once these are proved, we can formalise properties of $p$-adic $L$-functions. One of the most
important properties is, for an integer $n$ with $n \ge 1$,
$$ L_p (1 - n, \chi) = -(1 - \chi \omega^{-n}(p)p^{n - 1}) \frac{B_{n, \chi \omega^{-n}}}{n} $$
Recall that the function corresponding to $1 - n$ is $<a>^{1 - n}$. One must show that $<a>^{1 - n}$ is 
an element of the weight space. formalising the first definition would have made showing this result a 
lot tougher, since showing the analytic continuation of these functions is nontrivial, even on paper.

\section{Evaluation at negative integers}
\label{section4}
We shall now prove that our chosen definition of the $p$-adic $L$-function is equivalent to the original one, that is, 
it takes the same values at negative integers : for $n > 1$,
$$ L_p (1 - n, \chi) = -(1 - \chi \omega^{-n}(p)p^{n - 1}) \frac{B_{n, \chi \omega^{-n}}}{n} $$
For this section, we assume that $R$ is a normed commutative $\mathbb{Q}_p$-algebra and $\mathbb{Q}$-algebra, 
which is complete, nontrivial, and has no zero divisors. The scalar multiplication structure obtained from $\mathbb{Q}$ 
and $\mathbb{Q}_p$ are compatible, given by the condition \lean{is\_scalar\_tower ℚ ℚ\_[p] R} (see \cite{DD}). It is also non-archimedean, which are encapsulated by the following hypotheses:
\begin{lstlisting}
  na : ∀ (n : ℕ) (f : ℕ → R), 
    ∥∑ (i : ℕ) in finset.range n, f i∥ ≤ ⨆ (i : zmod n), ∥f i.val∥
  na' : ∀ (n : ℕ) (f : (zmod n)ˣ → R), 
    ∥∑ i : (zmod n)ˣ, f i∥ ≤ ⨆ (i : (zmod n)ˣ), ∥f i∥
\end{lstlisting}
The prime $p$ is odd, and we choose positive natural numbers $d$ and $c$ which are mutually coprime and are also coprime to 
$p$. The Dirichlet character $\chi$ has level $d p^m$, where $m$ is positive. We also assume $\chi$ is even and $d$ divides 
its conductor. Let us first explain why we need the latter condition.

\subsection{Factors of the conductor}
We explain here why we need $d$ to divide the conductor of $\chi$. In this section, we do not differentiate between the associated Dirichlet 
character and the Dirichlet character. 

Recall that $\chi \omega^{-1}$ actually denotes the Dirichlet 
character multiplication of $\chi$ and $\omega^{-1}$. As mentioned in the previous section, in order to translate between sums on 
$\mathbb{Z}/ d p^n \mathbb{Z} ^{\times}$ and $\mathbb{Z}/ d p^n \mathbb{Z}$, one needs that, for all $x \in \mathbb{Z}/ d p^n \mathbb{Z}$ 
such that $x$ is not a unit, $\chi \omega^{-k} (x) = 0$ for all $k > 0$. This is equivalent to saying, $\forall y \in \mathbb{N}$, such that 
$gcd (y, d) \ne 1$ and $gcd (y, p) \ne 1$, $gcd (y, (\chi \omega^{-k})\texttt{.conductor}) \ne 1$. 

Given coprime natural numbers $k_1, k_2$ and a Dirichlet character $\psi$ of level $k_1 k_2$, one can find primitive Dirichlet characters 
$\psi_1$ and $\psi_2$ of levels $k_1$ and $k_2$ respectively such that $\psi = \psi_1 \psi_2$ : 
\begin{lstlisting}
  lemma dirichlet_character.eq_mul_of_coprime_of_dvd_conductor {m n : ℕ} 
  [fact (0 < m * n)] (χ : dirichlet_character R (m * n)) (hχ : m | χ.conductor) 
  (hcop : m.coprime n) : ∃ (χ₁ : dirichlet_character R m) 
  (χ₂ : dirichlet_character R n), χ₁.is_primitive ∧ 
  χ = χ₁.change_level (dvd_mul_right m n) * χ₂.change_level (dvd_mul_left n m) 
\end{lstlisting}

Thus, given $k > 0$, we can find primitive Dirichlet characters $\chi_1$ and $\chi_2$ with conductors $z_1$ and $z_2$ such that 
$z_1 | d$ and $z_2 | p^m$ and $\chi_1 \chi_2 = \chi \omega^{-k}$. The condition that $d$ divides the conductor of $\chi$ ensures 
that $z_1 = d$. As a result, if $gcd (y, d) \ne 1$, then $gcd (y, z_1 z_2) \ne 1$, so $\chi \omega^{-k} (y) = 0$.

\subsection{Main Result}
Note that the same result holds when $\chi$ is odd or when $p = 2$, the proofs differ slightly. We shall 
skip most of the details of the proof, since these are very calculation intensive. We shall instead highlight the key concepts 
that are used. 

The proof consists of two steps : breaking up the integral in the LHS into three sums, 
and evaluating each of these sums. This is very calculation intensive, and was the longest part of the project. 
The proof is very similar to the proof of Theorem 12.2 in \cite{cyc}. 

%\subsection{Breaking up into three sums}
Using the fact that the space of locally constant functions is dense in $C((\mathbb{Z}/d \mathbb{Z})^{\times} \times \mathbb{Z}_p^{\times}, R)$, 
we observe that the integral $L_p (1 - n, \chi)$ is the same as :
$$ L_p (1 - n, \chi) = \lim_{j \to \infty} \sum_{a \in (\mathbb{Z}/ d p^j \mathbb{Z})^{\times}} E_{c, j} (\chi \omega^{-1} (a) <a>^{n - 1}) \label{eqn:1} $$
$$ = \lim_{j \to \infty} \bigg ( \sum_{a \in (\mathbb{Z}/ d p^j \mathbb{Z})^{\times}} \chi \omega^{-n} a^{n - 1} \bigg \{ \frac{a}{d p^j} \bigg \} - 
  \sum_{a \in (\mathbb{Z}/ d p^j \mathbb{Z})^{\times}} \chi \omega^{-n} a^{n - 1} \bigg ( c \bigg \{ \frac{c^{-1} a}{d p^j} \bigg \} \bigg ) 
  + \bigg ( \frac{c - 1}{2} \bigg ) \sum_{a \in (\mathbb{Z}/ d p^j \mathbb{Z})^{\times}} \chi \omega^{-n} a^{n - 1} \bigg ) $$

Going from the first equation to the second took about 600 lines of code, which can be found in \lean{try.lean} (add link). While the proof (on paper) is only a page long, 
this is very calculation heavy in Lean, because one needs to shift between elements coerced to different types, such as $\mathbb{Z}/ (d p^j) \mathbb{Z}$, 
$\mathbb{Z}/ d \mathbb{Z} \times \mathbb{Z}/ p^j \mathbb{Z}$, $\mathbb{Z}/ d \mathbb{Z} \times \mathbb{Z}_p$, $R$ and their units. Moreover, when each of these types occur 
as locally constant or continuous functions, one needs to separately prove that each of these functions 
is also (respectively) locally constant or continuous. Some other difficulties include several different ways to write obtain the same term, such as \lean{equiv.inv\_fun}, 
\lean{equiv.symm}, \lean{ring\_equiv.symm} and \lean{ring\_equiv.to\_equiv.inv\_fun}. We have constructed several lemmas to simplify traversing between these terms. 

Each of these sums are then evaluated separately in \lean{UVW.lean}. This is dependent on the following lemma : 
$$ \lim_{j \to \infty} \frac{1}{d p^j} \sum_{i \in \mathbb{Z}/ d p^j \mathbb{Z}} \chi \omega^{-n} (i) i^n = B_{n, \chi \omega^{-n}} $$ 

This is similar to what we need to compute the first sum in \eqref{eqn:1} :
\begin{lstlisting}
  tendsto (λ (j : ℕ), ∑ (x : (zmod (d * p ^ j))ˣ),
  ((asso_dirichlet_character (χ.mul (teichmuller_character_mod_p' p R ^ n))) ↑x *
  ↑(↑x.val) ^ (n - 1)) • (algebra_map ℚ R) (int.fract (↑x / (↑d * ↑p ^ j))))
  at_top
  (nhds ((1 - (asso_dirichlet_character (χ.mul (teichmuller_character_mod_p' p R ^ n))) ↑p * ↑p ^ (n - 1)) *
  general_bernoulli_number (χ.mul (teichmuller_character_mod_p' p R ^ n)) n))
\end{lstlisting}

In order to convert this sum into a sum over \lean{finset.range}, we show that :
\begin{lstlisting}
  lemma helper_U_3 (x : ℕ) : finset.range (d * p^x) = 
  set.finite.to_finset (set.finite_of_finite_inter (finset.range (d * p^x)) 
  ({x | ¬ x.coprime d})) ∪ ((set.finite.to_finset (set.finite_of_finite_inter 
  (finset.range (d * p^x)) ({x | ¬ x.coprime p}))) ∪ set.finite.to_finset 
  (set.finite_of_finite_inter (finset.range (d * p^x)) 
  ({x | x.coprime d} ∩ {x | x.coprime p}))) 
\end{lstlisting}

This is equivalent to saying :
$$ \mathbb{Z} / d p^k \mathbb{Z} \simeq \{ x \in \mathbb{N} | gcd (x, d) \ne 1 \} \cup \{ x \in \mathbb{N} | gcd (x, p) \ne 1 \} 
\cup (\mathbb{Z} / d p^k \mathbb{Z})^{\times} $$
The condition that $d$ divides the conductor is then used to show that the associated Dirichlet character is 0 everywhere except 
$(\mathbb{Z} / d p^k \mathbb{Z})^{\times}$. 

Evaluating the middle sum is the most tedious. It is first broken into two sums, so that the previous result can be used. Then, a 
change of variable from $a$ to $c^{-1} a$ is applied. The variable $c$ is coerced to $\mathbb{Z}/ d p^{2k} \mathbb{Z}$, increasing 
the number of coercions significantly, thus lengthening the calculations. 

Finally, the last sum is 0. This follows by substituting $a$ in the summand with $-a$. This is where one uses that $\chi$ is even. 

There were two ways to do calculations with respect to inequalities on the norm : working with lemmas regarding \lean{filter.tendsto}, 
or using the following lemma : 
\begin{lstlisting}
  metric.tendsto_at_top : ∀ {α : Type u_1} {β : Type} [pseudo_metric_space α] 
  [nonempty β] [semilattice_sup β] {u : β → α} {a : α}, 
  tendsto u at_top (nhds a) ↔ ∀ (ε : ℝ), ε > 0 → 
  (∃ (N : β), ∀ (n : β), n ≥ N → dist (u n) a < ε)
\end{lstlisting}
We would like to point out that working with \lean{filter.tendsto} instead of \lean{metric.tendsto\_at\_top} really simplified 
calculations. This is because, often, the \lean{ε} we would choose would be complicated, making our calculations more 
complicated. As an example, suppose we want to prove :
\begin{lstlisting}
  (h : filter.tendsto (λ x, f x) at_top (nhds 0)) → filter.tendsto (λ x, c * f x) at_top (nhds 0)
\end{lstlisting}
This is a one-line proof using \lean{filter.tendsto\_const\_mul}. However, if done using \lean{metric.tendsto\_at\_top}, 
given $\varepsilon > 0$, we must pick an $N$ such that $\lVert f x \rVert < \varepsilon / c$, and use $N$ to complete the proof. 
Most of such issues can be dealt with using the lemma \lean{filter.tendsto\_congr'}. 

Hence, we try to avoid using \lean{metric.tendsto\_at\_top} when possible. The only cases where it is used is when direct inequalities 
need to be dealt with; this happens precisely when the non-archimedean condition on $R$ needs to be used. Hence, this is a good 
indicator of where the non-Archimedean condition is needed.

\section{Conclusion}
\label{section5}
\subsection{Analysis}
We list some of the observations that arose while working on this paper. 
Throughout this paper, \lean{abbreviation} has played an important part. They help to reduce the number of \lean{def} for a prticular type. A technical 
difficulty is that one cannot use tactic \lean{rw} to unfold the underlying definition. One must either use \lean{delta}, which often slows compilation 
time, or make a lemma unfolding the \lean{abbreviation}.  

The tactic \lean{rw} does not always work inside sums. As a result, one must use 
the \lean{conv} tactic to get to the expression inside the sum. While using the \lean{conv} tactic, one is said to be working 
in \lean{conv} mode. Using the \lean{conv} tactic not only lengthens the proof, but also limits the tactics one can use; the 
only tactics one can use inside \lean{conv} mode are \lean{rw}, \lean{apply\_congr}(similar to \lean{apply}), \lean{simp} and 
\lean{norm\_cast}. Another way around sums is to use \lean{simp\_rw}, however, this increases compilation time of the proof. 
Moreover, \lean{simp\_rw} rewrites the lemma as many times as applicable, and is an unsuitable choice if one wants to apply 
the lemma just once. 

Another problem that was recurring was the ratio of implicit to explicit variables. The $p$-adic $L$-function, for example, has 19 arguments, of which 7 are explicit, and $p$, 
$d$ and $R$ are implicit. This is problematic because 7 is already a large number of hypotheses. Excluding $R$ often means that either Lean guesses or abstracts the correct term, 
or it asks for them explicitly. In the latter case, one also gets as additional goals all the hypotheses that are dependent on $R$ and implicit, such as \lean{normed\_comm\_ring R}. 
Moreover, one cannot get out of \lean{conv} mode unless all these goals are solved. This is difficult since \lean{apply\_instance} does not work in \lean{conv} mode. The other 
alternative is to explicitly provide terms using \lean{@}, however this leads to very large expressions. 

Working with Dirichlet characters was challenging. This is because, given $a, b \in \mathbb{N}$ such that $a = b$, Lean does not identify 
\lean{dirichlet\_character R a = dirichlet\_character R b}. Tactics such as \lean{subst} also fail. A workaround was putting \lean{h:a = b} as a local hypothesis and then using 
\lean{congr'}. We then end up with the goal \lean{dirichlet\_character R a == dirichlet\_character R b}. The API for \lean{heq} suggests that this should be avoided as much as possible. 
Another workaround was to define and use \lean{dirichlet\_character R a ≃ dirichlet\_character R b}. However, this would slow down the compilation a lot, sometimes also leading to 
deterministic timeouts. 

\subsection{Statistics}
When initially completed, this project consisted of around 18,000 lines of code. A major refactor was then done, keeping in mind several of the points mentioned above, specifically 
using properties of filters instead of metric space calculations wherever possible. All properties regarding particular types (such as Dirichlet characters) were also compiled together 
in separate files wherever possible. Keeping in mind the spirit of \lean{mathlib}, these properties have been made in the greatest generality as much as possible. 
After the refactor, there are about 15000 lines of code, put into 10 files (check!). 

While most properties regarding Bernoulli numbers and polynomials have been put into \lean{mathlib}, the rest of the work is on a private repository. The author hopes to push the 
work directly to Lean 4, once the required port is complete.

\subsection{Related and future work} % some error occurs if I remove the *
There are several projects that require Dirichlet characters and properties of the $p$-adic integers. These include the project on the formalisation of Fermat's last theorem (link). 
There is also an effort by Prof David Loeffler which involves formalisation of the classical Dirichlet $L$-function, that is somewhat dependent on this work. 

In the future, the author hopes to be able to work on Iwasawa theory, for which the $p$-adic $L$-function is a key ingredient. She also hopes to formalise more properties of Bernoulli numbers, 
that are a fundamental component of number theory.

\bibliography{ITP-2023}

\end{document}
